<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Well Anomaly Detection</title>
    <!-- Google Fonts for that Sci-Fi look -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Orbitron:wght@400;700&family=Rajdhani:wght@500;600&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --bg-dark: #050b14;
        --card-bg: rgba(15, 22, 35, 0.95);
        --card-border: #1e293b;
        --primary-cyan: #00f0ff;
        --primary-blue: #2d8cf0;
        --text-main: #e2e8f0;
        --text-muted: #94a3b8;
        --danger: #ff2a2a;
        --success: #00ff9d;
        --input-bg: #0a0f18;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Rajdhani", sans-serif;
        background-color: var(--bg-dark);
        background-image: linear-gradient(
            rgba(0, 240, 255, 0.03) 1px,
            transparent 1px
          ),
          linear-gradient(90deg, rgba(0, 240, 255, 0.03) 1px, transparent 1px);
        background-size: 30px 30px;
        color: var(--text-main);
        min-height: 100vh;
        padding: 10px;
        font-size: 14px; /* Base font size reduced */
      }

      .container {
        width: 100%;
        max-width: 1400px;
        margin: 0 auto;
      }

      header {
        text-align: center;
        margin-bottom: 15px;
        padding: 10px;
      }

      header h1 {
        font-family: "Orbitron", sans-serif;
        font-size: 1.8rem; /* Reduced from 2.5rem */
        margin-bottom: 5px;
        background: linear-gradient(90deg, #fff, var(--primary-cyan));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-transform: uppercase;
        letter-spacing: 2px;
        text-shadow: 0 0 15px rgba(0, 240, 255, 0.3);
      }

      header p {
        font-size: 0.9rem;
        color: var(--primary-blue);
        letter-spacing: 1px;
        text-transform: uppercase;
      }

      .main-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px; /* Tighter gap */
      }

      .card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 8px;
        padding: 15px; /* Reduced padding */
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        position: relative;
        overflow: hidden;
      }

      .card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 1px;
        background: linear-gradient(
          90deg,
          transparent,
          var(--primary-cyan),
          transparent
        );
      }

      .card h2 {
        color: var(--primary-cyan);
        margin-bottom: 15px;
        font-size: 1.1rem; /* Compact header */
        font-family: "Orbitron", sans-serif;
        border-bottom: 1px solid var(--card-border);
        padding-bottom: 5px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .form-group {
        margin-bottom: 10px; /* Reduced margin */
      }

      label {
        display: block;
        margin-bottom: 3px;
        color: var(--primary-blue);
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      input,
      select {
        width: 100%;
        padding: 8px 10px; /* Compact padding */
        height: 36px;
        background: var(--input-bg);
        border: 1px solid var(--card-border);
        border-radius: 2px;
        color: var(--primary-cyan);
        font-family: "Fira Code", monospace;
        font-size: 0.85rem;
        transition: all 0.2s ease;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: var(--primary-cyan);
        box-shadow: 0 0 8px rgba(0, 240, 255, 0.15);
      }

      ::-webkit-calendar-picker-indicator {
        filter: invert(1);
        cursor: pointer;
        opacity: 0.6;
        transform: scale(0.8);
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px; /* Tighter gap */
      }

      button {
        width: 100%;
        padding: 10px; /* Compact button */
        background: linear-gradient(45deg, #0f4c81 0%, #00f0ff 100%);
        color: #000;
        border: none;
        border-radius: 2px;
        font-size: 0.9rem;
        font-weight: 700;
        font-family: "Orbitron", sans-serif;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
        clip-path: polygon(
          8px 0,
          100% 0,
          100% calc(100% - 8px),
          calc(100% - 8px) 100%,
          0 100%,
          0 8px
        );
      }

      button:hover {
        transform: translateY(-1px);
        filter: brightness(1.2);
      }

      /* Compact button specific colors */
      #checkRecommendations {
        background: linear-gradient(45deg, #2d1b4e 0%, #bc13fe 100%);
        color: white;
      }

      #loadHistory {
        background: #1e293b;
        color: var(--primary-cyan);
        border: 1px solid var(--primary-cyan);
        font-size: 0.8rem;
        padding: 8px;
      }

      .result {
        margin-top: 15px;
        display: none;
        animation: slideIn 0.3s ease;
      }

      .result.show {
        display: block;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .loading {
        display: none;
        text-align: center;
        padding: 15px;
      }

      .spinner {
        border: 2px solid rgba(0, 240, 255, 0.1);
        border-top: 2px solid var(--primary-cyan);
        border-radius: 50%;
        width: 25px;
        height: 25px;
        animation: spin 0.8s linear infinite;
        margin: 0 auto 8px;
      }

      /* small spinner for inline buttons */
      .btn-spinner {
        display: inline-block;
        vertical-align: middle;
        width: 14px;
        height: 14px;
        border: 2px solid rgba(0, 240, 255, 0.12);
        border-top: 2px solid var(--primary-cyan);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin-right: 8px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .info-box {
        background: rgba(45, 140, 240, 0.1);
        border-left: 2px solid var(--primary-blue);
        padding: 10px;
        margin-bottom: 15px;
        color: var(--text-muted);
        font-size: 0.8rem;
      }

      .info-box strong {
        color: var(--primary-cyan);
        display: inline-block;
        margin-right: 5px;
        font-family: "Orbitron", sans-serif;
      }

      .success-message {
        background: rgba(0, 255, 157, 0.05);
        border: 1px solid var(--success);
        color: var(--success);
        padding: 8px;
        margin-top: 10px;
        font-family: "Fira Code", monospace;
        font-size: 0.8rem;
        display: none;
        text-align: center;
      }
      .success-message.show {
        display: block;
      }

      .error {
        background: rgba(255, 42, 42, 0.1);
        border: 1px solid var(--danger);
        color: var(--danger);
        padding: 10px;
        font-size: 0.8rem;
        font-family: "Fira Code", monospace;
        margin-top: 10px;
      }

      /* Compact Logs ‚Äî scrollable JSON panels */
      pre,
      #anomaliesJson,
      #readingsJson,
      #recommendationsJson {
        background: #000;
        border: 1px solid #333;
        color: var(--success);
        font-family: "Fira Code", monospace;
        padding: 10px;
        border-radius: 4px;
        font-size: 0.75rem;
        line-height: 1.3;
        white-space: pre; /* preserve JSON newlines/indent */
        max-height: 260px; /* make panels scrollable */
        overflow-y: auto;
        overflow-x: hidden;
        scrollbar-width: thin;
        scrollbar-color: var(--primary-blue) #000;
      }

      .history-section h3 {
        color: var(--text-main);
        margin: 20px 0 10px 0;
        font-size: 1rem;
        font-family: "Orbitron", sans-serif;
        border-left: 2px solid var(--primary-blue);
        padding-left: 8px;
      }

      /* Compact Tables */
      table {
        background: transparent !important;
        border: 1px solid var(--card-border) !important;
        font-size: 0.8rem;
      }

      th {
        background: rgba(45, 140, 240, 0.1) !important;
        color: var(--primary-cyan) !important;
        font-family: "Orbitron", sans-serif;
        font-weight: normal;
        text-transform: uppercase;
        padding: 8px !important;
        border: 1px solid var(--card-border) !important;
      }

      td {
        border: 1px solid var(--card-border) !important;
        color: var(--text-muted);
        font-family: "Fira Code", monospace;
        padding: 6px 8px !important;
      }

      tr:hover {
        background: rgba(255, 255, 255, 0.02) !important;
      }

      @media (max-width: 1024px) {
        .main-grid {
          grid-template-columns: 1fr;
        }
      }
      @media (max-width: 480px) {
        .form-row {
          grid-template-columns: 1fr;
          gap: 5px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>üîç AI Anomaly Detection</h1>
        <p>System Online // Ready for Telemetry</p>
      </header>

      <div class="main-grid">
        <!-- Input Form Card -->
        <div class="card">
          <h2>Sensor Input</h2>

          <div class="info-box">
            <strong>‚ÑπÔ∏è PROTOCOL</strong> Neural network analysis initiation.
          </div>

          <form id="sensorForm">
            <div class="form-row">
              <div class="form-group">
                <label for="wellId">Well ID *</label>
                <input
                  type="text"
                  id="wellId"
                  name="wellId"
                  placeholder="e.g., Well_001"
                  required
                />
              </div>
              <div class="form-group">
                <label for="liftType">Well Type *</label>
                <select id="liftType" name="liftType" required>
                  <option value="">-- Select Type --</option>
                  <option value="Rod Pump">Rod Pump</option>
                  <option value="ESP">ESP</option>
                  <option value="Gas Lift">Gas Lift</option>
                </select>
              </div>
            </div>

            <!-- Timestamp removed (Dynamic) -->

            <!-- Rod Pump Fields -->
            <div id="rodPumpFields" style="display: none">
              <div class="form-row">
                <div class="form-group">
                  <label id="strokeLabel">Strokes/Min (0.5-12.0)</label>
                  <input
                    type="number"
                    id="strokesPerMinute"
                    name="strokesPerMinute"
                    step="0.1"
                    placeholder="6"
                  />
                </div>
                <div class="form-group">
                  <label id="torqueLabel">Torque in-lbs (100k-1.8M)</label>
                  <input
                    type="number"
                    id="torque"
                    name="torque"
                    step="1000"
                    placeholder="900000"
                  />
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label id="loadLabel">Polish Rod Load lbs (0-125k)</label>
                  <input
                    type="number"
                    id="polishRodLoad"
                    name="polishRodLoad"
                    step="100"
                    placeholder="50000"
                  />
                </div>
                <div class="form-group">
                  <label id="fillageLabel">Pump Fillage % (0-100)</label>
                  <input
                    type="number"
                    id="pumpFillage"
                    name="pumpFillage"
                    step="1"
                    placeholder="80"
                  />
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label id="tubingPressureLabel"
                    >Tubing Pressure psi (0-5000)</label
                  >
                  <input
                    type="number"
                    id="tubingPressureRod"
                    name="tubingPressureRod"
                    step="1"
                    placeholder="2500"
                  />
                </div>
              </div>
            </div>

            <!-- ESP Fields -->
            <div id="espFields" style="display: none">
              <div class="form-row">
                <div class="form-group">
                  <label id="motorTempLabel">Motor ¬∞F (50-1500)</label>
                  <input
                    type="number"
                    id="motorTempEsp"
                    name="motorTempEsp"
                    step="1"
                    placeholder="500"
                  />
                </div>
                <div class="form-group">
                  <label id="motorCurrentLabel">Motor Current A (0-200)</label>
                  <input
                    type="number"
                    id="motorCurrentEsp"
                    name="motorCurrentEsp"
                    step="1"
                    placeholder="100"
                  />
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label id="dischargePressureLabel"
                    >Discharge Pressure psi (0-5000)</label
                  >
                  <input
                    type="number"
                    id="dischargePressure"
                    name="dischargePressure"
                    step="1"
                    placeholder="2500"
                  />
                </div>
                <div class="form-group">
                  <label id="intakePressureLabel"
                    >Pump Intake Pressure psi (0-5000)</label
                  >
                  <input
                    type="number"
                    id="pumpIntakePressure"
                    name="pumpIntakePressure"
                    step="1"
                    placeholder="1200"
                  />
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label id="motorVoltageLabel">Motor Voltage V (0-5000)</label>
                  <input
                    type="number"
                    id="motorVoltage"
                    name="motorVoltage"
                    step="1"
                    placeholder="3000"
                  />
                </div>
              </div>
            </div>

            <!-- Gas Lift Fields -->
            <div id="gasLiftFields" style="display: none">
              <div class="form-row">
                <div class="form-group">
                  <label id="injectionRateLabel"
                    >Injection Rate scf/d (0-2000)</label
                  >
                  <input
                    type="number"
                    id="injectionRate"
                    name="injectionRate"
                    step="1"
                    placeholder="1000"
                  />
                </div>
                <div class="form-group">
                  <label id="injectionTempLabel"
                    >Injection Temperature ¬∞F (0-1000)</label
                  >
                  <input
                    type="number"
                    id="injectionTemperature"
                    name="injectionTemperature"
                    step="1"
                    placeholder="500"
                  />
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label id="bottomholePressureLabel"
                    >Bottomhole Pressure psi (50-5000)</label
                  >
                  <input
                    type="number"
                    id="bottomholePressure"
                    name="bottomholePressure"
                    step="1"
                    placeholder="2500"
                  />
                </div>
                <div class="form-group">
                  <label id="injectionPressureLabel"
                    >Injection Pressure psi (100-5000)</label
                  >
                  <input
                    type="number"
                    id="injectionPressure"
                    name="injectionPressure"
                    step="1"
                    placeholder="2000"
                  />
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label id="cycleTimeLabel">Cycle Time minutes (5-180)</label>
                  <input
                    type="number"
                    id="cycleTime"
                    name="cycleTime"
                    step="1"
                    placeholder="60"
                  />
                </div>
              </div>
            </div>

            <button type="submit">Initialize Scan</button>
          </form>

          <div id="loading" class="loading">
            <div class="spinner"></div>
            <p style="font-size: 0.8rem; color: var(--primary-cyan)">
              PROCESSING...
            </p>
          </div>

          <div id="result" class="result"></div>
          <div id="successMessage" class="success-message">‚úì DATA INGESTED</div>
          <div id="errorMessage" class="error" style="display: none"></div>
        </div>

        <!-- Results/History Card -->
        <div class="card">
          <h2>Activity Log</h2>

          <div class="well-selector">
            <div class="form-group">
              <label for="wellSelect">Target Well:</label>
              <div style="display: flex; gap: 5px">
                <select id="wellSelect" style="flex: 2">
                  <option value="">-- DB ACCESS --</option>
                </select>
                <button
                  type="button"
                  id="loadHistory"
                  style="flex: 1; margin: 0; height: 36px"
                >
                  History
                </button>
              </div>
            </div>
            <button
              type="button"
              id="checkRecommendations"
              style="margin-top: 5px"
            >
              üìã AI Recommendations
            </button>
          </div>

          <div
            id="recommendationsTable"
            style="display: none; margin-top: 15px"
          >
            <h3
              style="
                color: var(--primary-cyan);
                margin-bottom: 10px;
                font-size: 0.9rem;
                font-family: 'Orbitron', sans-serif;
              "
            >
              üìä Operation Directives
            </h3>
            <div style="overflow-x: auto">
              <table
                id="recTable"
                style="width: 100%; border-collapse: collapse"
              >
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Action</th>
                    <th>Pri</th>
                    <th>Status</th>
                    <th>Reason</th>
                    <th>Src</th>
                    <th>Conf</th>
                    <th>Time</th>
                  </tr>
                </thead>
                <tbody id="recTableBody"></tbody>
              </table>
            </div>
            <div
              id="recCount"
              style="
                margin-top: 8px;
                font-size: 0.75rem;
                color: var(--text-muted);
                font-family: 'Fira Code', monospace;
                text-align: right;
              "
            ></div>
          </div>

          <div
            class="history-section"
            id="historySection"
            style="display: none"
          >
            <h3>Detected Anomalies</h3>
            <div id="anomaliesJson"></div>

            <h3>Telemetry Log</h3>
            <div id="readingsJson"></div>

            <h3>AI Directives</h3>
            <div id="recommendationsJson"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Timestamp default logic removed (Dynamic on submit)

      // Dynamic field ranges and visibility based on lift type
      const liftTypeFields = {
        "Rod Pump": {
          fields: ["rodPumpFields"],
          elementIds: [
            "strokesPerMinute",
            "torque",
            "polishRodLoad",
            "pumpFillage",
            "tubingPressureRod",
          ],
        },
        ESP: {
          fields: ["espFields"],
          elementIds: [
            "motorTempEsp",
            "motorCurrentEsp",
            "dischargePressure",
            "pumpIntakePressure",
            "motorVoltage",
          ],
        },
        "Gas Lift": {
          fields: ["gasLiftFields"],
          elementIds: [
            "injectionRate",
            "injectionTemperature",
            "bottomholePressure",
            "injectionPressure",
            "cycleTime",
          ],
        },
      };

      // Function to update form visibility
      function updateFieldVisibility() {
        const selectedType = document.getElementById("liftType").value;

        // Hide all field groups
        document.getElementById("rodPumpFields").style.display = "none";
        document.getElementById("espFields").style.display = "none";
        document.getElementById("gasLiftFields").style.display = "none";

        // Show selected field group
        if (selectedType === "Rod Pump") {
          document.getElementById("rodPumpFields").style.display = "block";
        } else if (selectedType === "ESP") {
          document.getElementById("espFields").style.display = "block";
        } else if (selectedType === "Gas Lift") {
          document.getElementById("gasLiftFields").style.display = "block";
        }
      }

      // Update form visibility when lift type changes
      document
        .getElementById("liftType")
        .addEventListener("change", updateFieldVisibility);

      // Initialize visibility on page load
      updateFieldVisibility();

      // Load wells on page load
      async function loadWells() {
        try {
          const response = await fetch("/api/wells");
          const data = await response.json();
          const select = document.getElementById("wellSelect");
          data.wells.forEach((well) => {
            const option = document.createElement("option");
            option.value = well;
            option.textContent = well;
            select.appendChild(option);
          });
        } catch (error) {
          console.error("Error loading wells:", error);
        }
      }

      // Handle form submission
      document
        .getElementById("sensorForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const loading = document.getElementById("loading");
          const resultDiv = document.getElementById("result");
          const errorDiv = document.getElementById("errorMessage");
          const successDiv = document.getElementById("successMessage");

          resultDiv.classList.remove("show");
          errorDiv.style.display = "none";
          successDiv.classList.remove("show");
          loading.style.display = "block";

          // Build form data based on selected well type
          // Dynamic Timestamp: Current Local Time
          const now = new Date();
          now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
          const dynamicTimestamp = now.toISOString().slice(0, 16);

          const liftType = document.getElementById("liftType").value;
          const formData = {
            well_id: document.getElementById("wellId").value,
            timestamp: dynamicTimestamp,
            lift_type: liftType,
          };

          // Extract well-type specific fields
          if (liftType === "Rod Pump") {
            formData.strokes_per_minute =
              document.getElementById("strokesPerMinute").value || null;
            formData.torque = document.getElementById("torque").value || null;
            formData.polish_rod_load =
              document.getElementById("polishRodLoad").value || null;
            formData.pump_fillage =
              document.getElementById("pumpFillage").value || null;
            formData.tubing_pressure =
              document.getElementById("tubingPressureRod").value || null;
          } else if (liftType === "ESP") {
            formData.motor_temp =
              document.getElementById("motorTempEsp").value || null;
            formData.motor_current =
              document.getElementById("motorCurrentEsp").value || null;
            formData.discharge_pressure =
              document.getElementById("dischargePressure").value || null;
            formData.pump_intake_pressure =
              document.getElementById("pumpIntakePressure").value || null;
            formData.motor_voltage =
              document.getElementById("motorVoltage").value || null;
          } else if (liftType === "Gas Lift") {
            formData.injection_rate =
              document.getElementById("injectionRate").value || null;
            formData.injection_temperature =
              document.getElementById("injectionTemperature").value || null;
            formData.bottomhole_pressure =
              document.getElementById("bottomholePressure").value || null;
            formData.injection_pressure =
              document.getElementById("injectionPressure").value || null;
            formData.cycle_time =
              document.getElementById("cycleTime").value || null;
          }

          try {
            const response = await fetch("/api/insert-reading", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(formData),
            });

            const data = await response.json();
            loading.style.display = "none";

            if (response.ok) {
              successDiv.classList.add("show");

              // Compact Result Display
              let resultHTML = `
                <div style="background: ${
                  data.anomaly_detected
                    ? "rgba(61, 16, 16, 0.9)"
                    : "rgba(11, 45, 16, 0.9)"
                }; 
                            border-left: 3px solid ${
                              data.anomaly_detected ? "#ff2a2a" : "#00ff9d"
                            }; 
                            border-radius: 4px; padding: 12px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <h3 style="color: ${
                          data.anomaly_detected ? "#ff2a2a" : "#00ff9d"
                        }; font-family: 'Orbitron', sans-serif; font-size: 0.95rem; margin: 0;">
                            ${
                              data.anomaly_detected
                                ? "‚ö†Ô∏è CRITICAL ANOMALY"
                                : "‚úì NOMINAL"
                            }
                        </h3>
                        <span style="font-family: 'Fira Code', monospace; font-size: 0.75rem; color: #aaa;">SCORE: ${
                          data.anomaly_score !== undefined
                            ? data.anomaly_score
                            : "N/A"
                        }</span>
                    </div>
                    <pre style="background: #000; color: #00ff9d; padding: 8px; border-radius: 2px; border: 1px solid #333; font-size: 0.75rem; margin: 0; max-height: 300px; overflow-y: auto;">${JSON.stringify(
                      data,
                      null,
                      2
                    )}</pre>
                </div>`;

              resultDiv.innerHTML = resultHTML;
              resultDiv.classList.add("show");

              document.getElementById("sensorForm").reset();
              document.getElementById("sensorForm").reset();
            } else {
              errorDiv.textContent = data.error || "System error";
              errorDiv.style.display = "block";
            }
          } catch (error) {
            loading.style.display = "none";
            errorDiv.textContent = "NetErr: " + error.message;
            errorDiv.style.display = "block";
          }
        });

      // Load history with inline button loader and reveal Recommendations
      document
        .getElementById("loadHistory")
        .addEventListener("click", async () => {
          const wellId = document.getElementById("wellSelect").value;
          if (!wellId) {
            alert("Select Target Well");
            return;
          }

          const loadBtn = document.getElementById("loadHistory");
          const recBtn = document.getElementById("checkRecommendations");
          const originalText = loadBtn.innerHTML;
          loadBtn.disabled = true;
          loadBtn.innerHTML = '<span class="btn-spinner"></span> Loading...';

          try {
            const response = await fetch(`/api/well-history/${wellId}`);
            if (!response.ok) throw new Error(`${response.status}`);
            const data = await response.json();

            const anomaliesJsonDiv = document.getElementById("anomaliesJson");
            anomaliesJsonDiv.textContent =
              data.anomalies && data.anomalies.length > 0
                ? JSON.stringify(data.anomalies, null, 2)
                : "[] // NULL";

            const readingsJsonDiv = document.getElementById("readingsJson");
            readingsJsonDiv.textContent =
              data.readings && data.readings.length > 0
                ? JSON.stringify(data.readings, null, 2)
                : "[] // NULL";

            document.getElementById("historySection").style.display = "block";

            // Restore History button to default label and enabled state
            loadBtn.disabled = false;
            loadBtn.innerHTML = "History";

            // Move the AI Recommendations button to the bottom of the card (after history)
            try {
              const historySection = document.getElementById("historySection");
              historySection.insertAdjacentElement("afterend", recBtn);
              recBtn.style.marginTop = "10px";
            } catch (e) {
              // ignore if DOM move fails
            }
          } catch (error) {
            loadBtn.disabled = false;
            loadBtn.innerHTML = originalText;
            alert("DB Err: " + error.message);
          }
        });

      // Check Recommendations
      document
        .getElementById("checkRecommendations")
        .addEventListener("click", async () => {
          const tableDiv = document.getElementById("recommendationsTable");
          const tableBody = document.getElementById("recTableBody");
          const recCount = document.getElementById("recCount");

          tableDiv.style.display = "block";
          tableBody.innerHTML =
            "<tr><td colspan='8' style='padding: 10px; text-align: center; color: var(--primary-cyan); font-size: 0.8rem;'>Scanning...</td></tr>";

          try {
            const response = await fetch("/api/operation-recommendations");
            const data = await response.json();

            if (!response.ok) {
              tableBody.innerHTML = `<tr><td colspan='8' style='padding: 10px; color: var(--danger)'>Err: ${data.error}</td></tr>`;
              return;
            }

            tableBody.innerHTML = "";
            if (data.recommendations && data.recommendations.length > 0) {
              data.recommendations.forEach((rec) => {
                const row = document.createElement("tr");
                row.style.backgroundColor =
                  rec.status === "pending"
                    ? "rgba(255, 193, 7, 0.05)"
                    : "transparent";

                // Condensed Table Row
                row.innerHTML = `
                  <td><strong>${rec.well_id || "-"}</strong></td>
                  <td style="color: #fff;">${rec.action || "-"}</td>
                  <td>
                    <span style="padding: 2px 4px; border-radius: 2px; font-size: 0.7rem; 
                        background: ${
                          rec.priority === "high"
                            ? "rgba(255, 42, 42, 0.2)"
                            : rec.priority === "medium"
                            ? "rgba(255, 193, 7, 0.2)"
                            : "rgba(0, 255, 157, 0.2)"
                        }; 
                        color: ${
                          rec.priority === "high"
                            ? "#ff2a2a"
                            : rec.priority === "medium"
                            ? "#ffc107"
                            : "#00ff9d"
                        };">
                      ${
                        rec.priority
                          ? rec.priority.toUpperCase().substring(0, 3)
                          : "-"
                      }
                    </span>
                  </td>
                  <td>${rec.status || "pend"}</td>
                  <td style="max-width: 150px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${
                    rec.reason
                  }">${rec.reason || "-"}</td>
                  <td>${
                    rec.prediction_source === "ml_model" ? "ML" : "Rule"
                  }</td>
                  <td style="color: var(--primary-cyan);">${
                    rec.confidence || rec.probability
                      ? Math.round(
                          parseFloat(rec.confidence || rec.probability) * 100
                        ) + "%"
                      : "-"
                  }</td>
                  <td style="font-size: 0.7rem">${
                    rec.created_at
                      ? new Date(rec.created_at).toLocaleTimeString([], {
                          hour: "2-digit",
                          minute: "2-digit",
                        })
                      : "-"
                  }</td>
                `;
                tableBody.appendChild(row);
              });
              recCount.textContent = `Total: ${data.recommendations.length}`;
            } else {
              tableBody.innerHTML =
                "<tr><td colspan='8' style='padding: 15px; text-align: center;'>No Directives</td></tr>";
              recCount.textContent = "0";
            }
          } catch (err) {
            tableBody.innerHTML = `<tr><td colspan='8' style='color: var(--danger)'>NetErr</td></tr>`;
          }
        });

      loadWells();
    </script>
  </body>
</html>
